#!/bin/bash

PROD="reclaim"

if [[ $1 = "stop" ]]
then
    echo "Shutting down $PROD"
    docker-compose -f config/docker-compose.yml down
    exit 0
fi

if [[ $1 = "restart" ]]
then
    echo "Restarting $PROD"
    docker-compose -f config/docker-compose.yml down
fi

if ([[ $1 = "start_demo" ]] || [[ $1 = "restart_demo" ]])
then
    echo -n "Starting $PROD Demo..."

    # check whether cert has already been generated
    if ! docker run --rm -v reclaim-gnunet:/volume alpine ls /volume/gns/gns_ca_cert.pem &> /dev/null
    then
      echo "\n"
      echo "No CA cert found. Generating..."
      if [ -f ./bin/generate-ca ]
      then
        ./bin/generate-ca
      else
        echo "Error... CA helper not found!"
        exit 1
      fi
    else
        echo "gns certificate has already been added"
    fi

    #docker-compose -f config/docker-compose_demo.yml pull
    docker-compose -f config/docker-compose_demo.yml up -d
    echo "started."
    exit 0
fi

if ([[ $1 = "start" ]] || [[ $1 = "restart" ]])
then
    echo -n "Starting $PROD..."

    # check whether cert has already been generated
    if ! docker run --rm -v reclaim-gnunet:/volume alpine ls /volume/gns/gns_ca_cert.pem &> /dev/null
    then
      echo "\n"
      echo "No CA cert found. Generating..."
      if [ -f ./bin/generate-ca ]
      then
        ./bin/generate-ca
      else
        echo "Error... CA helper not found!"
        exit 1
      fi
    else
        echo "gns certificate has already been added"
    fi

    docker-compose -f config/docker-compose.yml pull
    docker-compose -f config/docker-compose.yml up -d
    echo "started."
    exit 0
fi

if [[ $1 = "purge_demo" ]]
then
    echo "Purging $PROD demo"
    docker-compose -f config/docker-compose_demo.yml down --remove
    echo "Do you also want to remove the named volumes (persistent data)?"
    echo -n "(Y/n) "
    read input
    if [[ $input = "Y" ]]
    then
        echo "removing named volumes"
        docker volume rm reclaim-gnunet || true
        docker volume rm reclaim || true
    else
        echo "not removing named volumes"
    fi
    exit 0
fi


if [[ $1 = "purge" ]]
then
    echo "Purging $PROD"
    docker-compose -f config/docker-compose.yml down --remove
    echo "Do you also want to remove the named volumes (persistent data)?"
    echo -n "(Y/n) "
    read input
    if [[ $input = "Y" ]]
    then
        echo "removing named volumes"
        docker volume rm reclaim-gnunet || true
        docker volume rm reclaim || true
    else
        echo "not removing named volumes"
    fi
    exit 0
fi

echo "                     __      _         "
echo "   ________  _ _____/ /___ _(_)___ ___ "
echo '  / ___/ _ \(_) ___/ / __ `/ / __ `__ \'
echo " / /  /  __/ / /__/ / /_/ / / / / / / /"
echo "/_/   \___(_)\___/_/\__,_/_/_/ /_/ /_/ "
echo "                                       "
echo "https://reclaim-identity.io"
echo "(C) 2018 Fraunhofer AISEC"
echo ""
echo "Status:"
if [ -z `docker ps -q --no-trunc | grep $(docker-compose -f config/docker-compose.yml ps -q reclaim-service) 2>/dev/null` ]; then
  echo "* Service is not running."
else
  echo "* Service is running."
fi

if [ -z `docker ps -q --no-trunc | grep $(docker-compose -f config/docker-compose.yml ps -q reclaim-ui) 2>/dev/null` ]; then
  echo "* UI is not running."
else
  echo "* UI is running."
fi
echo ""
echo "Usage:"
echo "$0 start: starts $PROD"
echo "$0 start_demo: starts $PROD with one example relying party"
echo "$0 stop: shuts $PROD down"
echo "$0 restart: restarts $PROD"
echo "$0 restart_demo: restarts $PROD and one example relying party"
echo "$0 purge: shuts $PROD down and purges its data"

